"use strict";(self.webpackChunkApache_Cloudberry_Incubating_website=self.webpackChunkApache_Cloudberry_Incubating_website||[]).push([[29083],{59966:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var n=r(85893),t=r(11151);const o={title:"Query Processing Overview"},a="Query Processing Overview",i={id:"performance/optimize-queries/query-process-overview",title:"Query Processing Overview",description:"This topic provides an overview of how Apache Cloudberry processes queries. Understanding this process can be useful when writing and tuning queries.",source:"@site/versioned_docs/version-2.x/performance/optimize-queries/query-process-overview.md",sourceDirName:"performance/optimize-queries",slug:"/performance/optimize-queries/query-process-overview",permalink:"/docs/performance/optimize-queries/query-process-overview",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/cloudberry-site/edit/main/versioned_docs/version-2.x/performance/optimize-queries/query-process-overview.md",tags:[],version:"2.x",lastUpdatedBy:"Dianjin Wang",lastUpdatedAt:1754561742,formattedLastUpdatedAt:"Aug 7, 2025",frontMatter:{title:"Query Processing Overview"},sidebar:"docsbars",previous:{title:"Query Performance Overview",permalink:"/docs/performance/optimize-queries/"},next:{title:"Analyze Query Performance",permalink:"/docs/performance/optimize-queries/analyze-query-performance"}},c={},l=[{value:"Query planning and dispatch",id:"query-planning-and-dispatch",level:2},{value:"Apache Cloudberry query plans",id:"apache-cloudberry-query-plans",level:2},{value:"Parallel query execution",id:"parallel-query-execution",level:2}];function d(e){const s={code:"code",em:"em",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,t.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h1,{id:"query-processing-overview",children:"Query Processing Overview"}),"\n",(0,n.jsx)(s.p,{children:"This topic provides an overview of how Apache Cloudberry processes queries. Understanding this process can be useful when writing and tuning queries."}),"\n",(0,n.jsxs)(s.p,{children:["Users issue queries to Apache Cloudberry as they would to any database management system. They connect to the database instance on the Apache Cloudberry coordinator host using a client application such as ",(0,n.jsx)(s.code,{children:"psql"})," and submit SQL statements."]}),"\n",(0,n.jsx)(s.h2,{id:"query-planning-and-dispatch",children:"Query planning and dispatch"}),"\n",(0,n.jsx)(s.p,{children:"The coordinator receives, parses, and optimizes the query. The resulting query plan is either parallel or targeted. The coordinator dispatches parallel query plans to all segments."}),"\n",(0,n.jsx)(s.p,{children:"The coordinator dispatches targeted query plans to a single segment. Each segment is responsible for running local database operations on its own set of data. Most database operations\u2014such as table scans, joins, aggregations, and sorts\u2014run across all segments in parallel. Each operation is performed on a segment database independent of the data stored in the other segment databases."}),"\n",(0,n.jsxs)(s.p,{children:["Certain queries might access only data on a single segment, such as single-row ",(0,n.jsx)(s.code,{children:"INSERT"}),", ",(0,n.jsx)(s.code,{children:"UPDATE"}),", ",(0,n.jsx)(s.code,{children:"DELETE"}),", or ",(0,n.jsx)(s.code,{children:"SELECT"})," operations or queries that filter on the table distribution key column(s). In queries such as these, the query plan is not dispatched to all segments, but is targeted at the segment that contains the affected or relevant row(s)."]}),"\n",(0,n.jsx)(s.h2,{id:"apache-cloudberry-query-plans",children:"Apache Cloudberry query plans"}),"\n",(0,n.jsxs)(s.p,{children:["A query plan is the set of operations Apache Cloudberry will perform to produce the answer to a query. Each ",(0,n.jsx)(s.em,{children:"node"})," or step in the plan represents a database operation such as a table scan, join, aggregation, or sort. Plans are read and run from bottom to top."]}),"\n",(0,n.jsxs)(s.p,{children:["In addition to common database operations such as table scans, joins, and so on, Apache Cloudberry has an additional operation type called ",(0,n.jsx)(s.em,{children:"motion"}),". A motion operation involves moving tuples between the segments during query processing. Note that not every query requires a motion. For example, a targeted query plan does not require data to move across the interconnect."]}),"\n",(0,n.jsxs)(s.p,{children:["To achieve maximum parallelism during query runtime, Apache Cloudberry divides the work of the query plan into ",(0,n.jsx)(s.em,{children:"slices"}),". A slice is a portion of the plan that segments can work on independently. A query plan is sliced wherever a ",(0,n.jsx)(s.em,{children:"motion"})," operation occurs in the plan, with one slice on each side of the motion."]}),"\n",(0,n.jsx)(s.p,{children:"For example, consider the following simple query involving a join between two tables:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sql",children:"SELECT customer, amount\nFROM sales JOIN customer USING (cust_id)\nWHERE dateCol = '04-30-2016';\n"})}),"\n",(0,n.jsx)(s.p,{children:"The following figure shows the query plan. Each segment receives a copy of the query plan and works on it in parallel."}),"\n",(0,n.jsxs)(s.p,{children:["The query plan for this example has a ",(0,n.jsx)(s.em,{children:"redistribute motion"})," that moves tuples between the segments to complete the join. The redistribute motion is necessary because the customer table is distributed across the segments by ",(0,n.jsx)(s.code,{children:"cust_id"}),", but the sales table is distributed across the segments by ",(0,n.jsx)(s.code,{children:"sale_id"}),". To perform the join, the ",(0,n.jsx)(s.code,{children:"sales"})," tuples must be redistributed by ",(0,n.jsx)(s.code,{children:"cust_id"}),". The plan is sliced on either side of the redistribute motion, creating ",(0,n.jsx)(s.em,{children:"slice 1"})," and ",(0,n.jsx)(s.em,{children:"slice 2"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["This query plan has another type of motion operation called a ",(0,n.jsx)(s.em,{children:"gather motion"}),". A gather motion is when the segments send results back up to the coordinator for presentation to the client. Because a query plan is always sliced wherever a motion occurs, this plan also has an implicit slice at the very top of the plan (",(0,n.jsx)(s.em,{children:"slice 3"}),"). Not all query plans involve a gather motion. For example, a ",(0,n.jsx)(s.code,{children:"CREATE TABLE x AS SELECT..."})," statement would not have a gather motion because tuples are sent to the newly created table, not to the coordinator."]}),"\n",(0,n.jsx)(s.h2,{id:"parallel-query-execution",children:"Parallel query execution"}),"\n",(0,n.jsxs)(s.p,{children:["Apache Cloudberry creates a number of database processes to handle the work of a query. On the coordinator, the query worker process is called the ",(0,n.jsx)(s.em,{children:"query dispatcher"})," (QD). The QD is responsible for creating and dispatching the query plan. It also accumulates and presents the final results. On the segments, a query worker process is called a ",(0,n.jsx)(s.em,{children:"query executor"})," (QE). A QE is responsible for completing its portion of work and communicating its intermediate results to the other worker processes."]}),"\n",(0,n.jsxs)(s.p,{children:["There is at least one worker process assigned to each ",(0,n.jsx)(s.em,{children:"slice"})," of the query plan. A worker process works on its assigned portion of the query plan independently. During query runtime, each segment will have a number of processes working on the query in parallel."]}),"\n",(0,n.jsxs)(s.p,{children:["Related processes that are working on the same slice of the query plan but on different segments are called ",(0,n.jsx)(s.em,{children:"gangs"}),". As a portion of work is completed, tuples flow up the query plan from one gang of processes to the next. This inter-process communication between the segments is referred to as the ",(0,n.jsx)(s.em,{children:"interconnect"})," component of Apache Cloudberry."]})]})}function h(e={}){const{wrapper:s}={...(0,t.a)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},11151:(e,s,r)=>{r.d(s,{Z:()=>i,a:()=>a});var n=r(67294);const t={},o=n.createContext(t);function a(e){const s=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),n.createElement(o.Provider,{value:s},e.children)}}}]);